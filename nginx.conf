events {
    worker_connections 1024;
}

http {
    upstream blockchain_node {
        server orasrs-node:8545;
    }

    # 存储API密钥的映射
    map $http_api_key $api_key_valid {
        default 0;
        "orasrs_demo_key_12345" 1;
        "orasrs_admin_key_67890" 1;
    }
    
    # 速率限制区域
    limit_req_zone $binary_remote_addr zone=api_rate:10m rate=5r/s;
    limit_req_zone $http_api_key zone=api_user_rate:10m rate=20r/s;

    server {
        listen 8080;
        
        # 主要的RPC代理端点
        location / {
            # 检查API密钥
            if ($api_key_valid != 1) {
                return 401 '{"error": "Invalid or missing API key"}';
            }
            
            # 应用速率限制
            limit_req zone=api_rate burst=10 nodelay;
            limit_req zone=api_user_rate burst=30 nodelay;
            
            # 检查请求体大小
            client_max_body_size 10M;
            
            # 设置代理头
            proxy_pass http://blockchain_node;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 设置代理读取超时
            proxy_read_timeout 60s;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            
            # 添加安全头
            add_header X-Frame-Options DENY;
            add_header X-Content-Type-Options nosniff;
            add_header X-Robots-Tag none;
        }
        
        # 专门用于读取操作的端点（可选开放）
        location /read {
            # 对于只读操作，可以稍微宽松一些
            limit_req zone=api_rate burst=20 nodelay;
            
            # 仅允许特定的只读RPC方法
            proxy_pass http://blockchain_node;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # 健康检查端点
        location /health {
            access_log off;
            return 200 '{"status": "healthy", "service": "orasrs-api-gateway"}';
        }
    }
}