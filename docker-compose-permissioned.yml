version: '3.8'

services:
  # OraSRS区块链节点
  orasrs-node:
    image: ethereum/client-go:stable
    command: 
      - --dev
      - --dev.period=1
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.api=eth,net,web3,personal,miner,admin
      - --http.corsdomain=*
      - --networkid=8888
      - --allow-insecure-unlock
      - --rpc.allow-unprotected-txs
      - --datadir=/geth-data
    volumes:
      - ./data/chain:/geth-data
    ports:
      - "30303:30303"  # P2P端口
    networks:
      - orasrs-network
    restart: unless-stopped

  # API网关，保护区块链节点
  nginx-gateway:
    image: nginx:alpine
    ports:
      - "8081:8080"  # 使用8081端口而非80端口
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./api_keys.json:/etc/nginx/api_keys.json:ro
    depends_on:
      - orasrs-node
    networks:
      - orasrs-network
    restart: unless-stopped

  # 监控面板 (可选)
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    volumes:
      - ./grafana-storage:/var/lib/grafana
    networks:
      - orasrs-network
    restart: unless-stopped

networks:
  orasrs-network:
    driver: bridge