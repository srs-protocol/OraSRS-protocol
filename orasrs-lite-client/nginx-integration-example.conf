# OraSRS Threat Intelligence Integration for Nginx
# This example shows how to integrate OraSRS threat intelligence with Nginx

# Main server configuration
server {
    listen 80;
    server_name example.com;

    # Location block to check threats before processing requests
    location / {
        # Use the OraSRS threat check API
        access_by_lua_block {
            local http = require "resty.http"
            local httpc = http.new()
            
            -- Check if the client IP is in the threat list
            local client_ip = ngx.var.remote_addr
            local res, err = httpc:request_uri("http://127.0.0.1:8080/api/check-threat", {
                method = "POST",
                body = '{"ip":"' .. client_ip .. '"}',
                headers = {
                    ["Content-Type"] = "application/json"
                }
            })
            
            if res and res.status == 200 then
                local cjson = require "cjson"
                local threat_data = cjson.decode(res.body)
                
                if threat_data.blocked then
                    ngx.status = 403
                    ngx.say("Access denied: Threat detected - " .. threat_data.reason)
                    ngx.exit(403)
                end
            end
        }

        # Your normal application configuration
        root /var/www/html;
        index index.html index.htm;
    }
}

# API endpoint for threat checking (this would be handled by OraSRS client)
server {
    listen 8080;
    server_name 127.0.0.1;
    
    # Location to receive threat check requests from Nginx
    location /api/check-threat {
        # This would be handled by the OraSRS client via Tauri
        # For demonstration, we're showing the integration pattern
        content_by_lua_block {
            ngx.req.read_body()
            local body = ngx.req.get_body_data()
            
            if body then
                ngx.log(ngx.INFO, "Received threat check request: " .. body)
                -- In a real implementation, this would call the OraSRS client via Tauri
                ngx.print([[{"blocked": false, "reason": "No threat detected", "threat_level": 0}]])
            else
                ngx.status = 400
                ngx.print("Bad Request")
            end
        }
    }
}