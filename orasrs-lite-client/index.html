<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OraSRS Lite Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a4d69, #4b86b4);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card h2 {
            margin-bottom: 15px;
            color: #4fc3f7;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-connected {
            background-color: #4caf50;
        }
        
        .status-disconnected {
            background-color: #f44336;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat {
            text-align: center;
            padding: 10px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #2196f3;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0d8bf2;
        }
        
        .threat-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .threat-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .threat-item:last-child {
            border-bottom: none;
        }
        
        .threat-ip {
            font-weight: bold;
            color: #ff9800;
        }
        
        .threat-type {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .threat-level {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .level-1 { background: #e8f5e9; color: #2e7d32; }
        .level-2 { background: #f3e5f5; color: #7b1fa2; }
        .level-3 { background: #fff3e0; color: #ef6c00; }
        .level-4 { background: #ffebee; color: #d32f2f; }
        .level-5 { background: #ffcdd2; color: #b71c1c; }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: #4caf50;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        
        .notification.high-risk {
            background: #f44336;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>OraSRS Lite Client</h1>
            <p class="subtitle">轻量级威胁情报订阅与阻断客户端</p>
        </header>
        
        <div class="dashboard">
            <div class="card">
                <h2>系统状态</h2>
                <div class="status-indicator">
                    <div class="status-dot status-connected" id="connection-status"></div>
                    <span>连接状态: 已连接</span>
                </div>
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-value" id="block-number">0</div>
                        <div class="stat-label">最新区块</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="threat-count">0</div>
                        <div class="stat-label">威胁数量</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="rule-count">0</div>
                        <div class="stat-label">防火墙规则</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="memory-usage">5MB</div>
                        <div class="stat-label">内存占用</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>添加防火墙规则</h2>
                <div class="form-group">
                    <label for="ip-input">IP地址</label>
                    <input type="text" id="ip-input" placeholder="输入IP地址，如: 192.168.1.100">
                </div>
                <div class="form-group">
                    <label for="rule-type">规则类型</label>
                    <select id="rule-type">
                        <option value="block">阻断</option>
                        <option value="allow">允许</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="duration">持续时间(小时)</label>
                    <input type="number" id="duration" value="24" min="1">
                </div>
                <button id="add-rule-btn">添加规则</button>
            </div>
            
            <div class="card">
                <h2>系统设置</h2>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="silent-mode" checked> 静默模式 (仅高危威胁时弹窗)
                    </label>
                </div>
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-value" id="memory-usage">5MB</div>
                        <div class="stat-label">内存占用</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="update-status">已同步</div>
                        <div class="stat-label">更新状态</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>威胁情报</h2>
                <div class="threat-list" id="threat-list">
                    <div class="threat-item">
                        <div class="threat-ip">104.28.29.30</div>
                        <div class="threat-type">恶意扫描</div>
                        <span class="threat-level level-4">高危</span>
                    </div>
                    <div class="threat-item">
                        <div class="threat-ip">185.132.189.10</div>
                        <div class="threat-type">DDoS攻击</div>
                        <span class="threat-level level-5">极高危</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>实时监控</h2>
            <p>监控网络流量并自动匹配威胁情报库</p>
            <div id="monitoring-status">监控已启动</div>
        </div>
        
        <div class="card">
            <h2>日志自动标记</h2>
            <div class="form-group">
                <label for="log-file-path">日志文件路径</label>
                <input type="text" id="log-file-path" placeholder="/var/log/firewall.log">
            </div>
            <button id="process-log-btn">处理日志文件</button>
            <div class="stats-grid" style="margin-top: 15px;">
                <div class="stat">
                    <div class="stat-value" id="critical-alerts-count">0</div>
                    <div class="stat-label">严重警报</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="annotated-logs-count">0</div>
                    <div class="stat-label">已标记日志</div>
                </div>
            </div>
        </div>
        
        <div class="notification" id="notification">
            <div class="notification-title">高危攻击警报</div>
            <div class="notification-content">检测到对 192.168.1.100 的勒索病毒通信</div>
        </div>
        
        <footer>
            <p>OraSRS Lite Client v2.0 | 轻量级威胁情报客户端 | 保持静默，仅在高危威胁时提醒</p>
        </footer>
    </div>
    
    <script>
        // Tauri API 调用函数
        async function getThreatIntel() {
            try {
                const result = await invoke('get_threat_intel');
                updateThreatList(result);
                document.getElementById('threat-count').textContent = result.length;
                return result;
            } catch (error) {
                console.error('获取威胁情报失败:', error);
                return [];
            }
        }
        
        async function addFirewallRule(ip, ruleType, durationHours) {
            try {
                const result = await invoke('add_firewall_rule', {
                    ip: ip,
                    ruleType: ruleType,
                    durationHours: durationHours
                });
                console.log('防火墙规则已添加:', result);
                showNotification('防火墙规则已添加');
                
                // 更新规则计数
                updateRuleCount();
                
                // 清空表单
                document.getElementById('ip-input').value = '';
                return result;
            } catch (error) {
                console.error('添加防火墙规则失败:', error);
                return null;
            }
        }
        
        async function getFirewallRules() {
            try {
                const result = await invoke('get_firewall_rules');
                document.getElementById('rule-count').textContent = result.filter(r => r.active).length;
                return result;
            } catch (error) {
                console.error('获取防火墙规则失败:', error);
                return [];
            }
        }
        
        async function syncWithChain() {
            try {
                const result = await invoke('sync_with_chain');
                document.getElementById('block-number').textContent = result.blockNumber;
                return result;
            } catch (error) {
                console.error('同步区块链失败:', error);
                return null;
            }
        }
        
        async function checkIPThreat(ip) {
            try {
                const result = await invoke('check_ip_threat', { ip: ip });
                return result;
            } catch (error) {
                console.error('检查IP威胁失败:', error);
                return null;
            }
        }
        
        function updateThreatList(threats) {
            const threatList = document.getElementById('threat-list');
            threatList.innerHTML = '';
            
            if (threats.length === 0) {
                threatList.innerHTML = '<div class="threat-item">无威胁情报</div>';
                return;
            }
            
            threats.forEach(threat => {
                const threatLevelClass = `level-${threat.threatLevel}`;
                const threatLevelText = threat.threatLevel >= 4 ? '高危' : 
                                         threat.threatLevel >= 3 ? '中危' : '低危';
                
                const threatItem = document.createElement('div');
                threatItem.className = 'threat-item';
                threatItem.innerHTML = `
                    <div class="threat-ip">${threat.ip}</div>
                    <div class="threat-type">${threat.threatType}</div>
                    <span class="threat-level ${threatLevelClass}">${threatLevelText}</span>
                `;
                threatList.appendChild(threatItem);
            });
        }
        
        async function updateRuleCount() {
            const rules = await getFirewallRules();
            document.getElementById('rule-count').textContent = rules.filter(r => r.active).length;
        }
        
        function showNotification(message, isHighRisk = false) {
            const notification = document.getElementById('notification');
            notification.querySelector('.notification-content').textContent = message;
            notification.className = 'notification' + (isHighRisk ? ' high-risk' : '');
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        function showHighRiskNotification(ip, threatType) {
            const notification = document.getElementById('notification');
            notification.querySelector('.notification-title').textContent = '高危攻击警报';
            notification.querySelector('.notification-content').textContent = 
                `检测到对 ${ip} 的${threatType}通信，已自动阻断`;
            notification.className = 'notification high-risk';
            notification.style.display = 'block';
            
            // 需要用户确认的高危威胁
            setTimeout(() => {
                if (notification.style.display !== 'none') {
                    notification.style.display = 'none';
                }
            }, 10000);
        }
        
        // 随机生成模拟威胁数据
        function generateMockThreats() {
            const mockThreats = [
                {
                    ip: "104.28.29.30",
                    threatType: "恶意扫描",
                    threatLevel: 4,
                    source: "blockchain",
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    ip: "185.132.189.10",
                    threatType: "DDoS攻击",
                    threatLevel: 5,
                    source: "blockchain",
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    ip: "45.12.221.88",
                    threatType: "恶意软件分发",
                    threatLevel: 3,
                    source: "blockchain",
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                }
            ];
            
            // 更新威胁列表
            updateThreatList(mockThreats);
            document.getElementById('threat-count').textContent = mockThreats.length;
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 初始化模拟数据
            generateMockThreats();
            
            // 更新规则计数
            await updateRuleCount();
            
            // 模拟区块链同步
            document.getElementById('block-number').textContent = '1,245,892';
            
            // 初始化静默模式状态
            try {
                const isSilent = await invoke('is_silent_mode');
                document.getElementById('silent-mode').checked = isSilent;
            } catch (error) {
                console.error('获取静默模式状态失败:', error);
                document.getElementById('silent-mode').checked = true; // 默认启用静默模式
            }
            
            // 静默模式切换事件
            document.getElementById('silent-mode').addEventListener('change', async (event) => {
                const enabled = event.target.checked;
                try {
                    await invoke('set_silent_mode', { enabled });
                    showNotification(enabled ? '已启用静默模式' : '已禁用静默模式');
                } catch (error) {
                    console.error('设置静默模式失败:', error);
                }
            });
            
            // 添加规则按钮事件
            document.getElementById('add-rule-btn').addEventListener('click', async () => {
                const ipInput = document.getElementById('ip-input');
                const ruleType = document.getElementById('rule-type').value;
                const duration = parseInt(document.getElementById('duration').value);
                
                const ip = ipInput.value.trim();
                if (!ip) {
                    alert('请输入IP地址');
                    return;
                }
                
                const ruleId = await addFirewallRule(ip, ruleType, duration);
                if (ruleId) {
                    showNotification(`已添加${ruleType}规则: ${ip}`);
                }
            });
            
            // 模拟实时监控功能
            setInterval(async () => {
                // 检查是否有高危威胁需要提醒
                // 这里是模拟，实际应用中会通过Tauri监听网络活动
                if (Math.random() < 0.1) { // 10% 概率模拟高危威胁
                    const maliciousIPs = ["203.0.113.10", "198.51.100.25", "192.0.2.55"];
                    const threatTypes = ["勒索病毒通信", "C2服务器连接", "数据外泄"];
                    
                    const randomIP = maliciousIPs[Math.floor(Math.random() * maliciousIPs.length)];
                    const randomThreat = threatTypes[Math.floor(Math.random() * threatTypes.length)];
                    
                    // 检查是否是高危威胁
                    const threat = await checkIPThreat(randomIP);
                    if (threat && threat.threatLevel >= 4) {
                        // 显示高危警报
                        try {
                            await invoke('show_high_risk_alert', { 
                                ip: randomIP, 
                                threatType: randomThreat 
                            });
                        } catch (error) {
                            console.error('显示高危警报失败:', error);
                        }
                    }
                }
            }, 5000);
            
            // 更新日志统计
            async function updateLogStats() {
                try {
                    const annotatedLogs = await invoke('get_annotated_logs');
                    const criticalAlerts = await invoke('get_critical_alerts');
                    
                    document.getElementById('annotated-logs-count').textContent = annotatedLogs.length;
                    document.getElementById('critical-alerts-count').textContent = criticalAlerts.length;
                } catch (error) {
                    console.error('更新日志统计失败:', error);
                }
            }
            
            // 处理日志文件按钮事件
            document.getElementById('process-log-btn').addEventListener('click', async () => {
                const logFilePath = document.getElementById('log-file-path').value.trim();
                if (!logFilePath) {
                    alert('请输入日志文件路径');
                    return;
                }
                
                try {
                    showNotification('正在处理日志文件...');
                    const result = await invoke('process_log_file', { filePath: logFilePath });
                    showNotification(`日志处理完成，发现 ${result.length} 条标记记录`);
                    await updateLogStats();
                } catch (error) {
                    console.error('处理日志文件失败:', error);
                    showNotification('处理日志文件失败: ' + error.message, true);
                }
            });
            
            // 定期更新日志统计
            setInterval(updateLogStats, 10000); // 每10秒更新一次
            updateLogStats(); // 初始更新
        });
    </script>
</body>
</html>